<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050505">
    <title>INDIE NEON // CYBERPUNK RADIO</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --neon-cyan: #00f3ff;
            --neon-pink: #ff006e;
            --neon-purple: #bc13fe;
            --neon-yellow: #ffea00;
            --dark-bg: #020204;
            --panel-bg: rgba(10, 10, 15, 0.6);
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: var(--dark-bg);
            color: #fff;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* WALLPAPER DE FUNDO */
        #wallpaper-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: opacity 1.5s ease-in-out;
        }

        #wallpaper-layer.loading {
            opacity: 0;
        }

        #wallpaper-layer.loaded {
            opacity: 1;
        }

        /* Overlay escuro para legibilidade */
        .wallpaper-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(2,2,4,0.85) 0%, rgba(2,2,4,0.6) 50%, rgba(2,2,4,0.85) 100%);
            z-index: 1;
            pointer-events: none;
        }

        /* Grade estática */
        .static-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 2;
            pointer-events: none;
        }

        /* CONTAINER PRINCIPAL */
        .app-container {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* HEADER CYBER */
        .cyber-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(0, 243, 255, 0.2);
            margin-bottom: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-box {
            width: 50px;
            height: 50px;
            border: 2px solid var(--neon-cyan);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 243, 255, 0.05);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
            animation: logoPulse 2s ease-in-out infinite;
        }

        @keyframes logoPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 243, 255, 0.3); }
            50% { box-shadow: 0 0 30px rgba(0, 243, 255, 0.5); }
        }

        .brand-text h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 900;
            letter-spacing: 3px;
            background: linear-gradient(90deg, var(--neon-cyan), var(--neon-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .brand-text span {
            font-size: 0.7rem;
            letter-spacing: 5px;
            color: var(--neon-purple);
            text-transform: uppercase;
        }

        /* STATUS INDICATOR */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255, 0, 110, 0.1);
            border: 1px solid rgba(255, 0, 110, 0.3);
            position: relative;
            overflow: hidden;
        }

        .status-indicator.live {
            background: rgba(0, 243, 255, 0.1);
            border-color: var(--neon-cyan);
        }

        .status-dot {
            width: 8px; height: 8px;
            background: var(--neon-pink);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--neon-pink);
        }

        .status-indicator.live .status-dot {
            background: var(--neon-cyan);
            box-shadow: 0 0 10px var(--neon-cyan);
            animation: blink 1s steps(2) infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* VISUALIZADOR CENTRAL */
        .visualizer-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 20px 0;
        }

        /* ANÉIS HOLOGRÁFICOS - Container centralizado */
        .hologram-rings {
            position: relative;
            width: 280px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 2px solid transparent;
        }

        .ring-1 {
            width: 280px; 
            height: 280px;
            border-top-color: var(--neon-cyan);
            border-right-color: var(--neon-purple);
            animation: spin 8s linear infinite;
        }

        .ring-2 {
            width: 238px; 
            height: 238px;
            border-bottom-color: var(--neon-pink);
            border-left-color: var(--neon-yellow);
            animation: spinReverse 12s linear infinite;
        }

        .ring-3 {
            width: 196px; 
            height: 196px;
            border: 1px dashed rgba(0, 243, 255, 0.3);
            animation: spin 16s linear infinite;
        }

        @keyframes spin { 
            from { transform: translate(-50%, -50%) rotate(0deg); } 
            to { transform: translate(-50%, -50%) rotate(360deg); } 
        }
        @keyframes spinReverse { 
            from { transform: translate(-50%, -50%) rotate(0deg); } 
            to { transform: translate(-50%, -50%) rotate(-360deg); } 
        }

        /* CANVAS VISUALIZADOR - Centralizado perfeitamente */
        #visualizer-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            pointer-events: none;
            z-index: 5;
        }

        /* CAPA DO ÁLBUM - Centralizada */
        .album-hologram {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: #000;
            border: 3px solid var(--neon-cyan);
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.4);
            overflow: hidden;
        }

        .album-hologram img {
            width: 100%; 
            height: 100%;
            object-fit: cover;
            opacity: 0.9;
        }

        /* INFO DA MÚSICA */
        .track-data {
            text-align: center;
            margin-top: 40px;
            position: relative;
            width: 100%;
        }

        .glitch-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 0 20px var(--neon-cyan);
        }

        .glitch-active {
            animation: textFlicker 0.3s steps(2) 3;
        }

        @keyframes textFlicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .artist-cyber {
            font-size: 1.1rem;
            color: var(--neon-pink);
            letter-spacing: 4px;
            text-transform: uppercase;
            margin-top: 10px;
            text-shadow: 0 0 15px var(--neon-pink);
        }

        .album-meta {
            font-size: 0.8rem;
            color: var(--neon-purple);
            margin-top: 5px;
            letter-spacing: 2px;
        }

        /* PAINEL DE CONTROLE */
        .control-panel {
            background: var(--panel-bg);
            border: 1px solid rgba(0, 243, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 25px;
            margin: 20px 0;
            position: relative;
            clip-path: polygon(
                0 10px, 10px 0, 
                calc(100% - 10px) 0, 100% 10px,
                100% calc(100% - 10px), calc(100% - 10px) 100%,
                10px 100%, 0 calc(100% - 10px)
            );
        }

        .controls-main {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 25px;
        }

        .cyber-btn {
            background: transparent;
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            clip-path: polygon(20% 0%, 100% 0%, 100% 80%, 80% 100%, 0% 100%, 0% 20%);
        }

        .cyber-btn:hover {
            background: rgba(0, 243, 255, 0.2);
            transform: scale(1.05);
        }

        .cyber-btn.play-btn {
            width: 80px;
            height: 80px;
            background: var(--neon-cyan);
            color: #000;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.6);
        }

        .cyber-btn.play-btn:hover {
            background: #fff;
            box-shadow: 0 0 60px rgba(0, 243, 255, 0.8);
        }

        .cyber-btn.play-btn.playing {
            background: var(--neon-pink);
            border-color: var(--neon-pink);
            box-shadow: 0 0 50px rgba(255, 0, 110, 0.6);
            animation: playPulse 2s ease-in-out infinite;
        }

        @keyframes playPulse {
            0%, 100% { box-shadow: 0 0 40px rgba(255, 0, 110, 0.6); }
            50% { box-shadow: 0 0 60px rgba(255, 0, 110, 0.8); }
        }

        /* VOLUME SLIDER */
        .volume-cyber {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .volume-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.7rem;
            color: var(--neon-cyan);
            letter-spacing: 2px;
        }

        .cyber-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(0, 243, 255, 0.2);
            outline: none;
        }

        .cyber-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--neon-cyan);
            cursor: pointer;
            box-shadow: 0 0 20px var(--neon-cyan);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }

        .volume-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            color: var(--neon-cyan);
            min-width: 40px;
            text-align: right;
        }

        /* HISTÓRICO */
        .history-cyber {
            margin-top: 10px;
        }

        .history-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .history-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            color: var(--neon-purple);
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .history-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--neon-purple), transparent);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(0, 243, 255, 0.05);
            border-left: 3px solid var(--neon-cyan);
            transition: all 0.2s;
            cursor: pointer;
        }

        .history-item:hover {
            background: rgba(0, 243, 255, 0.1);
            transform: translateX(5px);
            border-left-color: var(--neon-pink);
        }

        .history-thumb {
            width: 40px;
            height: 40px;
            border: 1px solid var(--neon-cyan);
            object-fit: cover;
        }

        .history-info h4 {
            font-size: 0.9rem;
            color: #fff;
            margin-bottom: 2px;
        }

        .history-info p {
            font-size: 0.75rem;
            color: var(--neon-cyan);
        }

        /* DECORAÇÕES DE CANTO */
        .corner {
            position: fixed;
            width: 30px;
            height: 30px;
            border: 2px solid var(--neon-cyan);
            z-index: 100;
            pointer-events: none;
        }

        .corner-tl { top: 20px; left: 20px; border-right: 0; border-bottom: 0; }
        .corner-tr { top: 20px; right: 20px; border-left: 0; border-bottom: 0; }
        .corner-bl { bottom: 20px; left: 20px; border-right: 0; border-top: 0; }
        .corner-br { bottom: 20px; right: 20px; border-left: 0; border-top: 0; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background: var(--neon-cyan); }

        /* Indicador de wallpaper */
        .wallpaper-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.6rem;
            color: var(--neon-cyan);
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="wallpaper-layer" class="loading"></div>
    <div class="wallpaper-overlay"></div>
    <div class="static-grid"></div>

    <div class="corner corner-tl"></div>
    <div class="corner corner-tr"></div>
    <div class="corner corner-bl"></div>
    <div class="corner corner-br"></div>

    <div class="wallpaper-indicator">WALLPAPER: UNSPLASH</div>

    <div class="app-container">
        <header class="cyber-header">
            <div class="logo-section">
                <div class="logo-box">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--neon-cyan)" stroke-width="2">
                        <circle cx="12" cy="12" r="2"/>
                        <path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5M19.1 4.9C23 8.8 23 15.1 19.1 19M4.9 19.1C1 15.2 1 8.8 4.9 4.9M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/>
                    </svg>
                </div>
                <div class="brand-text">
                    <h1>INDIE NEON</h1>
                    <span>Cyberpunk Radio</span>
                </div>
            </div>
            <div class="status-indicator" id="statusBadge">
                <div class="status-dot"></div>
                <span id="statusText" style="font-family:'Orbitron';font-size:0.75rem;letter-spacing:2px">OFFLINE</span>
            </div>
        </header>

        <section class="visualizer-container">
            <div class="hologram-rings">
                <div class="ring ring-1"></div>
                <div class="ring ring-2"></div>
                <div class="ring ring-3"></div>
                
                <!-- Canvas centralizado -->
                <canvas id="visualizer-canvas" width="280" height="280"></canvas>
                
                <!-- Capa do álbum centralizada -->
                <div class="album-hologram" id="albumCover">
                    <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#000;">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--neon-cyan)" stroke-width="1" opacity="0.5">
                            <path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="track-data">
                <h2 class="glitch-text" id="trackTitle">SINTONIZANDO...</h2>
                <p class="artist-cyber" id="trackArtist">Aguardando transmissão</p>
                <div class="album-meta" id="albumInfo">SYSTEM READY</div>
            </div>
        </section>

        <div class="control-panel">
            <div class="controls-main">
                <button class="cyber-btn" id="btnStop" aria-label="Parar">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                    </svg>
                </button>
                
                <button class="cyber-btn play-btn" id="btnPlay" aria-label="Play/Pause">
                    <svg id="iconPlay" width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <svg id="iconPause" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="display:none">
                        <rect x="6" y="4" width="4" height="16" rx="1"/>
                        <rect x="14" y="4" width="4" height="16" rx="1"/>
                    </svg>
                </button>
                
                <button class="cyber-btn" id="btniTunes" aria-label="Apple Music">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
                    </svg>
                </button>
            </div>

            <div class="volume-cyber">
                <span class="volume-label">VOL</span>
                <input type="range" class="cyber-slider" id="volSlider" min="0" max="1" step="0.01" value="0.85">
                <span class="volume-value" id="volValue">85%</span>
            </div>
        </div>

        <div class="history-cyber">
            <div class="history-header">
                <span class="history-title">// RECENT_LOGS</span>
                <div class="history-line"></div>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>

    <audio id="audioPlayer" crossorigin="anonymous" preload="none"></audio>

    <script>
        const CONFIG = {
            STREAM_URL: 'https://kathy.torontocast.com:3840/stream',
            STATUS_URL: 'https://kathy.torontocast.com:3840/status-json.xsl',
            META_INTERVAL: 10000,
            COLORS: ['#00f3ff', '#ff006e', '#39ff14', '#ffea00', '#bc13fe'],
            WALLPAPER_TOPICS: [
                'cyberpunk city neon',
                'futuristic technology',
                'neon lights night',
                'sci-fi architecture',
                'digital art abstract',
                'retrowave synthwave',
                'futuristic car neon',
                'cyberpunk street',
                'holographic abstract',
                'neon sign urban'
            ]
        };

        let state = {
            isPlaying: false,
            lastTitle: '',
            currentData: null,
            history: JSON.parse(localStorage.getItem('indie_neon_history_v3') || '[]'),
            audioContext: null,
            analyser: null,
            colorIndex: 0,
            currentWallpaper: null,
            wallpaperCache: new Map()
        };

        const elements = {
            audio: document.getElementById('audioPlayer'),
            trackTitle: document.getElementById('trackTitle'),
            trackArtist: document.getElementById('trackArtist'),
            albumInfo: document.getElementById('albumInfo'),
            albumCover: document.getElementById('albumCover'),
            historyList: document.getElementById('historyList'),
            canvas: document.getElementById('visualizer-canvas'),
            wallpaper: document.getElementById('wallpaper-layer')
        };

        // SISTEMA DE WALLPAPER
        async function changeWallpaper() {
            try {
                const topic = CONFIG.WALLPAPER_TOPICS[Math.floor(Math.random() * CONFIG.WALLPAPER_TOPICS.length)];
                const timestamp = Date.now();
                const unsplashUrl = `https://source.unsplash.com/1920x1080/?${encodeURIComponent(topic)}&sig=${timestamp}`;
                
                const img = new Image();
                img.onload = () => {
                    elements.wallpaper.style.backgroundImage = `url(${img.src})`;
                    elements.wallpaper.classList.remove('loading');
                    elements.wallpaper.classList.add('loaded');
                    state.currentWallpaper = img.src;
                    saveWallpaperToCache(topic, img.src);
                };
                
                img.onerror = () => {
                    tryFallbackWallpaper();
                };
                
                elements.wallpaper.classList.remove('loaded');
                elements.wallpaper.classList.add('loading');
                
                img.src = unsplashUrl;
                
            } catch (e) {
                console.error('Erro wallpaper:', e);
                tryFallbackWallpaper();
            }
        }

        function tryFallbackWallpaper() {
            const fallbackId = Math.floor(Math.random() * 1000);
            const fallbackUrl = `https://picsum.photos/1920/1080?random=${fallbackId}`;
            elements.wallpaper.style.backgroundImage = `url(${fallbackUrl})`;
            elements.wallpaper.classList.add('loaded');
        }

        function saveWallpaperToCache(topic, url) {
            if (state.wallpaperCache.size >= 10) {
                const firstKey = state.wallpaperCache.keys().next().value;
                state.wallpaperCache.delete(firstKey);
            }
            state.wallpaperCache.set(topic, url);
        }

        function cycleNeon() {
            state.colorIndex = (state.colorIndex + 1) % CONFIG.COLORS.length;
            const root = document.documentElement;
            const color = CONFIG.COLORS[state.colorIndex];
            const nextColor = CONFIG.COLORS[(state.colorIndex + 1) % CONFIG.COLORS.length];
            
            root.style.setProperty('--neon-cyan', color);
            root.style.setProperty('--neon-pink', nextColor);
        }

        async function updateMetadata() {
            try {
                const res = await fetch(CONFIG.STATUS_URL);
                const data = await res.json();
                const source = Array.isArray(data.icestats.source) ? data.icestats.source[0] : data.icestats.source;
                if (!source) return;
                
                const fullTitle = source.title;
                
                if (fullTitle && fullTitle !== state.lastTitle && fullTitle !== 'Indie Neon Radio') {
                    
                    if (state.lastTitle !== '') {
                        changeWallpaper();
                    }
                    
                    if (state.currentData) addToHistory(state.currentData);
                    
                    state.lastTitle = fullTitle;
                    let [artist, song] = fullTitle.split(' - ').map(s => s?.trim());
                    
                    if (!song) {
                        const parts = fullTitle.split(/ - | – | — /);
                        artist = parts[0];
                        song = parts[1] || parts[0];
                    }

                    elements.trackTitle.classList.add('glitch-active');
                    setTimeout(() => elements.trackTitle.classList.remove('glitch-active'), 1000);
                    
                    elements.trackTitle.textContent = song?.toUpperCase() || "DESCONHECIDO";
                    elements.trackArtist.textContent = artist || "TRANSMISSÃO ANÔNIMA";
                    
                    try {
                        const itRes = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(fullTitle)}&media=music&limit=1`);
                        const itData = await itRes.json();
                        
                        if (itData.results?.length > 0) {
                            const t = itData.results[0];
                            const img = t.artworkUrl100.replace('100x100bb', '600x600bb');
                            state.currentData = { song, artist, img, url: t.trackViewUrl };
                            elements.albumInfo.textContent = `[${t.collectionName}] ${new Date(t.releaseDate).getFullYear()}`;
                            elements.albumCover.innerHTML = `<img src="${img}" alt="${song}">`;
                        } else {
                            throw new Error('No results');
                        }
                    } catch (e) {
                        state.currentData = { song, artist, img: null, url: null };
                        elements.albumInfo.textContent = '[INDIE NEON ARCHIVE] 2024';
                        elements.albumCover.innerHTML = `
                            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--neon-cyan),var(--neon-pink));">
                                <span style="font-family:Orbitron;font-size:4rem;color:#000;">♪</span>
                            </div>`;
                    }
                }
            } catch (e) { console.error('Metadata error:', e); }
        }

        function addToHistory(data) {
            if (!data || state.history[0]?.song === data.song) return;
            state.history.unshift(data);
            state.history = state.history.slice(0, 8);
            localStorage.setItem('indie_neon_history_v3', JSON.stringify(state.history));
            renderHistory();
        }

        function renderHistory() {
            elements.historyList.innerHTML = state.history.map((item, i) => `
                <div class="history-item" onclick="window.open('${item.url || `https://music.apple.com/br/search?term=${encodeURIComponent(item.song + ' ' + item.artist)}`}', '_blank')" style="animation: slideIn 0.3s ease ${i * 0.05}s both">
                    <img src="${item.img || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40"><rect fill="%23000" width="40" height="40"/><text fill="%2300f3ff" x="50%" y="50%" text-anchor="middle" dy=".3em" font-family="Orbitron" font-size="16">♪</text></svg>'}" class="history-thumb">
                    <div class="history-info">
                        <h4>${item.song}</h4>
                        <p>${item.artist}</p>
                    </div>
                </div>
            `).join('');
        }

        // CONTROLES
        document.getElementById('btnPlay').addEventListener('click', async () => {
            if (state.isPlaying) {
                elements.audio.pause();
                state.isPlaying = false;
            } else {
                if (!state.audioContext) {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    state.audioContext = new AudioContext();
                }
                elements.audio.src = CONFIG.STREAM_URL;
                elements.audio.volume = document.getElementById('volSlider').value;
                try {
                    await elements.audio.play();
                    state.isPlaying = true;
                    
                    if (!state.currentWallpaper) {
                        changeWallpaper();
                    }
                    
                    initVisualizer();
                } catch (e) {
                    console.error('Play error:', e);
                }
            }
            updateUI();
        });

        function updateUI() {
            document.getElementById('iconPlay').style.display = state.isPlaying ? 'none' : 'block';
            document.getElementById('iconPause').style.display = state.isPlaying ? 'block' : 'none';
            document.getElementById('btnPlay').classList.toggle('playing', state.isPlaying);
            document.getElementById('statusBadge').classList.toggle('live', state.isPlaying);
            document.getElementById('statusText').textContent = state.isPlaying ? 'TRANSMITINDO' : 'OFFLINE';
        }

        // VISUALIZADOR CORRIGIDO E CENTRALIZADO
        function initVisualizer() {
            if (!state.audioContext || state.analyser) return;
            
            try {
                const src = state.audioContext.createMediaElementSource(elements.audio);
                state.analyser = state.audioContext.createAnalyser();
                src.connect(state.analyser);
                state.analyser.connect(state.audioContext.destination);
                state.analyser.fftSize = 128;
                
                const ctx = elements.canvas.getContext('2d');
                const buffer = new Uint8Array(state.analyser.frequencyBinCount);
                
                // Dimensões do canvas definidas no HTML (280x280)
                const canvasSize = 280;
                const centerX = canvasSize / 2; // 140
                const centerY = canvasSize / 2; // 140
                
                let frameCount = 0;
                
                function draw() {
                    requestAnimationFrame(draw);
                    if (!state.isPlaying) return;
                    
                    // 30fps
                    frameCount++;
                    if (frameCount % 2 !== 0) return;
                    
                    state.analyser.getByteFrequencyData(buffer);
                    ctx.clearRect(0, 0, canvasSize, canvasSize);
                    
                    // Raio base alinhado com o anel interno (196px / 2 = 98px)
                    // Mas usamos um pouco menos para ficar dentro do anel
                    const baseRadius = 85;
                    const bars = 48; // Múltiplo de 360 para alinhamento perfeito
                    
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    
                    for (let i = 0; i < bars; i++) {
                        // Mapear frequência para altura da barra
                        const dataIndex = Math.floor((i / bars) * (buffer.length / 2));
                        const value = buffer[dataIndex] || 0;
                        const barHeight = (value / 255) * 50; // Altura máxima
                        
                        // Ângulo em radianos - começar do topo (-90 graus)
                        const angle = (i / bars) * Math.PI * 2 - Math.PI / 2;
                        
                        // Coordenadas do início (perto do centro)
                        const x1 = centerX + Math.cos(angle) * baseRadius;
                        const y1 = centerY + Math.sin(angle) * baseRadius;
                        
                        // Coordenadas do fim (para fora)
                        const x2 = centerX + Math.cos(angle) * (baseRadius + barHeight);
                        const y2 = centerY + Math.sin(angle) * (baseRadius + barHeight);
                        
                        // Cor alternada para efeito visual
                        if (i % 3 === 0) {
                            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--neon-cyan').trim();
                        } else if (i % 3 === 1) {
                            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--neon-pink').trim();
                        } else {
                            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--neon-purple').trim();
                        }
                        
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    }
                    
                    // Círculo central decorativo (opcional)
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, baseRadius - 5, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(0, 243, 255, 0.1)';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
                
                draw();
                
            } catch (e) { 
                console.log('Visualizer init:', e); 
            }
        }

        document.getElementById('btnStop').addEventListener('click', () => {
            elements.audio.pause();
            elements.audio.src = "";
            state.isPlaying = false;
            updateUI();
        });

        document.getElementById('btniTunes').addEventListener('click', () => {
            if (!state.currentData) return;
            const url = state.currentData?.url || `https://music.apple.com/br/search?term=${encodeURIComponent(state.currentData.song + ' ' + state.currentData.artist)}`;
            window.open(url, '_blank');
        });

        document.getElementById('volSlider').addEventListener('input', (e) => {
            elements.audio.volume = e.target.value;
            document.getElementById('volValue').textContent = Math.round(e.target.value * 100) + '%';
        });

        elements.audio.addEventListener('error', () => {
            state.isPlaying = false;
            updateUI();
        });

        // Inicialização
        renderHistory();
        setInterval(updateMetadata, CONFIG.META_INTERVAL);
        setInterval(cycleNeon, 8000);
        updateMetadata();
        setTimeout(changeWallpaper, 1000);
    </script>
</body>
</html>
